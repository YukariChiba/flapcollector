<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>DN42 Flap Alert</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />
        <style>
            :root {
                --bs-body-bg: #121417;
                --bs-card-bg: #1e2227;
                --bs-border-color: #2c3138;
                --accent-color: #3b82f6;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                background-color: var(--bs-body-bg);
            }
            .card {
                background-color: var(--bs-card-bg);
                border: 1px solid var(--bs-border-color);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 1.5rem;
            }
            .card-header {
                background-color: rgba(255, 255, 255, 0.03);
                border-bottom: 1px solid var(--bs-border-color);
                font-weight: 600;
                font-size: 0.95rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Controls Section */
            .filter-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #6c757d;
                margin-bottom: 0.5rem;
                display: block;
            }
            .btn-check:checked + .btn-outline-primary,
            .btn-check:checked + .btn-outline-light {
                background-color: var(--accent-color);
                border-color: var(--accent-color);
                color: white;
            }

            /* Table Styling */
            .table-container {
                max-height: 70vh;
                overflow-y: auto;
                position: relative;
            }
            .table {
                margin-bottom: 0;
                white-space: nowrap; /* Keep rows single line where possible */
            }
            .table thead th {
                position: sticky;
                top: 0;
                background-color: #252930;
                color: #adb5bd;
                font-weight: 600;
                border-bottom: 2px solid var(--bs-border-color);
                z-index: 10;
            }
            .table-hover tbody tr:hover {
                background-color: rgba(255, 255, 255, 0.03);
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1a1d21;
            }
            ::-webkit-scrollbar-thumb {
                background: #495057;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #6c757d;
            }

            /* Badges */
            .voter-badge {
                font-size: 0.7rem;
                padding: 0.35em 0.65em;
                background-color: rgba(255, 255, 255, 0.1);
                color: #adb5bd;
                border: 1px solid var(--bs-border-color);
                font-weight: normal;
            }
            .count-badge {
                font-size: 0.9rem;
                width: 32px;
                height: 32px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }

            /* Status Dashboard */
            .status-hero {
                font-size: 1.5rem;
                font-weight: 700;
            }

            /* Code Blocks */
            .code-box {
                background: #0d0f12;
                border: 1px solid #2c3138;
                border-radius: 6px;
                padding: 1rem;
                font-family:
                    "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
                    monospace;
                font-size: 0.85rem;
                color: #a5d6ff;
                position: relative;
                overflow-x: auto;
            }
            .copy-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                padding: 2px 8px;
                font-size: 0.75rem;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                border: none;
                border-radius: 4px;
                transition: 0.2s;
            }
            .copy-btn:hover {
                background: var(--accent-color);
            }

            /* Mobile Optimization */
            @media (max-width: 768px) {
                .table-container {
                    max-height: 60vh;
                }
                .mobile-stack {
                    flex-direction: column;
                }
                .voter-cell {
                    white-space: normal;
                    min-width: 200px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Main Container: Limits width on large screens -->
        <div class="container py-4" style="max-width: 1200px">
            <!-- Header -->
            <header
                class="d-flex justify-content-between align-items-center mb-4"
            >
                <div class="d-flex align-items-center gap-3">
                    <h1 class="h4 mb-0 fw-bold tracking-tight">
                        DN42 Flap Alert
                    </h1>
                    <div
                        id="loader"
                        class="spinner-border spinner-border-sm text-primary opacity-0 transition-opacity"
                        role="status"
                    ></div>
                </div>
                <div class="text-end">
                    <div class="badge bg-dark border text-muted fw-normal">
                        <i class="bi bi-clock-history me-1"></i> Auto-refresh:
                        30s
                    </div>
                </div>
            </header>

            <!-- Controls & Dashboard -->
            <div class="row g-3 mb-4">
                <!-- Filters -->
                <div class="col-lg-7">
                    <div
                        class="card h-100 border-0 bg-transparent shadow-none mb-0"
                    >
                        <div class="row g-3">
                            <!-- Consensus Filter -->
                            <div class="col-md-7 col-12">
                                <div class="card h-100 mb-0">
                                    <div class="card-body p-3">
                                        <span class="filter-label"
                                            >Consensus (Votes)</span
                                        >
                                        <div
                                            class="btn-group w-100"
                                            role="group"
                                        >
                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-all"
                                                value="1"
                                                onchange="setFilter('votes', 1)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-all"
                                                >All</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-min2"
                                                value="2"
                                                onchange="setFilter('votes', 2)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-min2"
                                                >&ge; 2</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-min3"
                                                value="3"
                                                checked
                                                onchange="setFilter('votes', 3)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-min3"
                                                >&ge; 3</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-min5"
                                                value="5"
                                                onchange="setFilter('votes', 5)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-min5"
                                                >&ge; 5</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-min7"
                                                value="7"
                                                onchange="setFilter('votes', 7)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-min7"
                                                >&ge; 7</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="filter"
                                                id="btn-min11"
                                                value="11"
                                                onchange="setFilter('votes', 11)"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="btn-min11"
                                                >&ge; 11</label
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- IP Family Filter -->
                            <div class="col-md-5 col-12">
                                <div class="card h-100 mb-0">
                                    <div class="card-body p-3">
                                        <span class="filter-label"
                                            >IP Family</span
                                        >
                                        <div
                                            class="btn-group w-100"
                                            role="group"
                                        >
                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="family"
                                                id="fam-all"
                                                value="all"
                                                checked
                                                onchange="setFilter('family', 'all')"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="fam-all"
                                                >All</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="family"
                                                id="fam-v4"
                                                value="v4"
                                                onchange="setFilter('family', 'v4')"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="fam-v4"
                                                >IPv4</label
                                            >

                                            <input
                                                type="radio"
                                                class="btn-check"
                                                name="family"
                                                id="fam-v6"
                                                value="v6"
                                                onchange="setFilter('family', 'v6')"
                                            />
                                            <label
                                                class="btn btn-sm btn-outline-light"
                                                for="fam-v6"
                                                >IPv6</label
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Stats -->
                <div class="col-lg-5">
                    <div
                        class="card h-100 mb-0 border-primary"
                        style="
                            background: linear-gradient(
                                145deg,
                                #1e2227 0%,
                                #16191d 100%
                            );
                        "
                    >
                        <div
                            class="card-body p-3 d-flex align-items-center justify-content-between"
                        >
                            <div>
                                <div
                                    class="text-muted small text-uppercase mb-1"
                                >
                                    Network Status
                                </div>
                                <div
                                    id="status-text"
                                    class="status-hero text-success"
                                >
                                    Loading...
                                </div>
                            </div>
                            <div
                                class="text-end ps-4 border-start border-secondary"
                            >
                                <div class="text-muted small">Total Active</div>
                                <div
                                    id="display-count"
                                    class="fs-2 fw-bold text-light"
                                >
                                    0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Table -->
            <div class="card overflow-hidden">
                <div
                    class="card-header d-flex justify-content-between align-items-center bg-transparent py-3"
                >
                    <span>Route Flapping Data</span>
                    <button
                        class="btn btn-sm btn-outline-secondary"
                        onclick="runAggregation()"
                    >
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0 table-container">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4" style="width: 30%">Prefix</th>
                                <th class="text-center" style="width: 10%">
                                    Votes
                                </th>
                                <th style="width: 60%">Source Servers</th>
                            </tr>
                        </thead>
                        <tbody id="roa-table-body">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer / Documentation Section -->
            <div class="row g-4 mt-2">
                <!-- Configuration Guide -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-terminal me-2"></i>Configuration
                            Guide
                        </div>
                        <div class="card-body">
                            <ul
                                class="nav nav-pills mb-3"
                                id="pills-tab"
                                role="tablist"
                            >
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link active btn-sm py-1 px-3"
                                        id="pills-docker-tab"
                                        data-bs-toggle="pill"
                                        data-bs-target="#pills-docker"
                                        type="button"
                                        role="tab"
                                    >
                                        Docker (StayRTR)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link btn-sm py-1 px-3"
                                        id="pills-bird-tab"
                                        data-bs-toggle="pill"
                                        data-bs-target="#pills-bird"
                                        type="button"
                                        role="tab"
                                    >
                                        BIRD (Direct)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link btn-sm py-1 px-3"
                                        id="pills-webhook-tab"
                                        data-bs-toggle="pill"
                                        data-bs-target="#pills-webhook"
                                        type="button"
                                        role="tab"
                                    >
                                        Webhook (Config)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="pills-tabContent">
                                <!-- Docker -->
                                <div
                                    class="tab-pane fade show active"
                                    id="pills-docker"
                                    role="tabpanel"
                                >
                                    <div class="code-box">
                                        <button
                                            class="copy-btn"
                                            onclick="copyCode('code-docker')"
                                        >
                                            Copy
                                        </button>
                                        <pre id="code-docker" class="m-0">
services:
  stayrtr:
    image: rpki/stayrtr:latest
    ports:
      - "8082:8282"
    command: >
      -cache https://flap-data.nia.dn42/{name}.json</pre
                                        >
                                    </div>
                                    <div
                                        class="mt-2 text-muted"
                                        style="font-size: 0.8rem"
                                    >
                                        Replace <code>{name}</code> with
                                        available files:
                                        <span class="font-monospace text-info"
                                            >all, min_2, min_3, min_5</span
                                        >.
                                    </div>
                                </div>

                                <!-- Bird -->
                                <div
                                    class="tab-pane fade"
                                    id="pills-bird"
                                    role="tabpanel"
                                >
                                    <div class="code-box">
                                        <button
                                            class="copy-btn"
                                            onclick="copyCode('code-bird')"
                                        >
                                            Copy
                                        </button>
                                        <pre id="code-bird" class="m-0">
protocol rpki roa_dn42_flap {
    roa4 { table roa_dn42_flap_4; };
    roa6 { table roa_dn42_flap_6; };

    remote "rpki.nia.dn42" port 8083;

    retry keep 120;
    refresh keep 300;
    expire keep 600;
}</pre
                                        >
                                    </div>
                                    <div
                                        class="mt-2 text-muted"
                                        style="font-size: 0.8rem"
                                    >
                                        Data source: <code>min_5.json</code>.
                                    </div>
                                </div>
                                <!-- Webhook Guide -->
                                <div
                                    class="tab-pane fade"
                                    id="pills-webhook"
                                    role="tabpanel"
                                >
                                    <div
                                        class="mb-2 text-muted"
                                        style="font-size: 0.8rem"
                                    >
                                        Contact us and then configure your
                                        FlapAlerted to send webhooks to us
                                        instead of polling.
                                    </div>
                                    <div class="code-box">
                                        <button
                                            class="copy-btn"
                                            onclick="copyCode('code-bird')"
                                        >
                                            Copy
                                        </button>
                                        <pre class="m-0">
# FlapAlerted > 4.1.5 is required
-webhookInstanceName "Instance ID (provided by us)"
-webhookUrlStart "https://flap-data.nia.dn42/start"
# IANA address: -webhookUrlStart "https://flap42-data.strexp.net/start"
-webhookUrlEnd "https://flap-data.nia.dn42/end"
# IANA address: -webhookUrlEnd "https://flap42-data.strexp.net/end"</pre
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-link me-2"></i>Useful Links
                        </div>
                        <div class="card-body">
                            <a
                                href="https://github.com/Kioubit/FlapAlerted"
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                            >
                                FlapAlerted
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Server List & JSON Links -->
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="bi bi-filetype-json me-2"></i>Raw JSON
                            Files
                        </div>
                        <div
                            class="list-group list-group-flush"
                            id="json-links-list"
                        >
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="card mb-0">
                        <div
                            class="card-header d-flex justify-content-between align-items-center"
                        >
                            <span
                                ><i class="bi bi-hdd-rack me-2"></i>Data
                                Sources</span
                            >
                            <span
                                class="badge bg-secondary"
                                id="server-count-badge"
                                >0</span
                            >
                        </div>
                        <ul
                            class="list-group list-group-flush small"
                            id="server-list"
                            style="max-height: 800px; overflow-y: auto"
                        >
                            <li
                                class="list-group-item bg-transparent text-muted text-center py-3"
                            >
                                Waiting for data...
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer Copyright -->
            <footer class="text-center text-muted small mt-5 mb-3">
                Strategic Explorations Network &copy; <span id="year"></span>
            </footer>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.getElementById("year").innerText =
                new Date().getFullYear();

            // --- State Management ---
            const STATE = {
                data: [], // { prefix, count, voters[] }
                filters: {
                    votes: 3, // 1, 2, 3, 5
                    family: "all", // 'all', 'v4', 'v6'
                },
                serverStatus: {},
                serverList: {},
                generatedTime: 0,
            };

            // --- Elements ---
            const UI = {
                tableBody: document.getElementById("roa-table-body"),
                displayCount: document.getElementById("display-count"),
                statusText: document.getElementById("status-text"),
                loader: document.getElementById("loader"),
                serverList: document.getElementById("server-list"),
                serverCountBadge: document.getElementById("server-count-badge"),
                jsonList: document.getElementById("json-links-list"),
            };

            // --- Initialization ---
            async function init() {
                // fix buttons default value
                const defaultVoteBtn = document.querySelector(
                    `input[name="filter"][value="${STATE.filters.votes}"]`,
                );
                if (defaultVoteBtn) defaultVoteBtn.checked = true;
                const defaultFamilyBtn = document.querySelector(
                    `input[name="family"][value="${STATE.filters.family}"]`,
                );
                if (defaultFamilyBtn) defaultFamilyBtn.checked = true;

                renderJsonLinks();
                await loadServerStatus();
                loadData();
                setInterval(() => {
                    loadServerStatus();
                    loadData();
                }, 30000);
            }

            // --- Data Fetching ---
            async function loadServerStatus() {
                try {
                    const resp = await fetch(`/status.json?t=${Date.now()}`);
                    if (!resp.ok)
                        throw new Error("Failed to load servers.json");
                    const json = await resp.json();

                    // Render List
                    UI.serverList.innerHTML = "";
                    const servers = json.servers || [];
                    const serverNames = Object.keys(servers);

                    UI.serverCountBadge.innerText = serverNames.length;

                    serverNames.sort().forEach((host) => {
                        const isOnline = servers[host];
                        const icon = isOnline
                            ? '<i class="bi bi-check2 text-success"></i>'
                            : '<i class="bi bi-exclamation-triangle text-warning"></i>';
                        const colorClass = isOnline
                            ? "text-light"
                            : "text-muted";

                        const li = document.createElement("li");
                        li.className =
                            "list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between";
                        li.innerHTML = `
                                        <span class="text-truncate small ${colorClass}" style="max-width:85%">${host}</span>
                                        ${icon}
                                    `;
                        UI.serverList.appendChild(li);
                    });
                } catch (e) {
                    UI.serverList.innerHTML = `<li class="list-group-item text-danger bg-transparent small">Status Error: ${e.message}</li>`;
                }
            }

            async function loadData() {
                UI.loader.classList.remove("opacity-0");

                try {
                    // Fetch the aggregated file directly
                    const res = await fetch(`/all.json?t=${Date.now()}`);
                    if (!res.ok) throw new Error("Failed to load data");
                    const json = await res.json();

                    // Store global generation time for calculation
                    STATE.generatedTime =
                        json.metadata?.generated ||
                        Math.floor(Date.now() / 1000);

                    // Process ROAs
                    // We map the backend format to our internal STATE.data format
                    STATE.data = (json.roas || []).map((r) => {
                        const votersObj = r.metadata || {};

                        // Convert metadata object to array for easier rendering
                        const votersList = Object.entries(votersObj).map(
                            ([host, stats]) => {
                                // Calculate details for tooltip
                                const firstSeen =
                                    stats.FirstSeen || STATE.generatedTime;
                                const totalCount = stats.TotalCount || 0;
                                const duration = Math.max(
                                    1,
                                    STATE.generatedTime - firstSeen,
                                );
                                const rate = totalCount / duration; // flaps per second

                                return {
                                    host: host,
                                    totalCount: totalCount,
                                    duration: duration,
                                    rate: rate,
                                };
                            },
                        );

                        // Sort voters alphabetically
                        votersList.sort((a, b) => a.host.localeCompare(b.host));

                        return {
                            prefix: r.prefix,
                            count: votersList.length, // Number of voters
                            voters: votersList,
                        };
                    });

                    // Sort: High votes first, then Prefix
                    STATE.data.sort(
                        (a, b) =>
                            b.count - a.count ||
                            a.prefix.localeCompare(b.prefix),
                    );

                    renderTable();
                } catch (e) {
                    console.error(e);
                    UI.tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger py-4">Error loading data: ${e.message}</td></tr>`;
                } finally {
                    UI.loader.classList.add("opacity-0");
                }
            }

            // --- Rendering ---
            function setFilter(type, value) {
                STATE.filters[type] = value;
                renderTable();
            }

            function renderTable() {
                const { votes, family } = STATE.filters;

                // Filter Data
                const filtered = STATE.data.filter((item) => {
                    // Vote Filter
                    if (item.count < votes) return false;

                    // Family Filter
                    const isV6 = item.prefix.includes(":");
                    if (family === "v4" && isV6) return false;
                    if (family === "v6" && !isV6) return false;

                    return true;
                });

                // Update Dashboard
                UI.displayCount.innerText = filtered.length;
                updateStatusText(filtered.length);

                // Render Rows
                if (filtered.length === 0) {
                    UI.tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-muted">No flapping routes found matching criteria.</td></tr>`;
                    return;
                }

                UI.tableBody.innerHTML = filtered
                    .map((row) => {
                        // Badge Color Logic (Same as before)
                        let badgeClass = "bg-secondary";
                        if (row.count >= 5) badgeClass = "bg-danger";
                        else if (row.count >= 3)
                            badgeClass = "bg-warning text-dark";
                        else if (row.count >= 2)
                            badgeClass = "bg-info text-dark";

                        // Generate Voters HTML with detailed hover info
                        const votersHtml = row.voters
                            .map((v) => {
                                // Format duration (e.g., 1h 20m)
                                const durStr = formatDuration(v.duration);
                                // Format rate (e.g., 0.5/s)
                                const rateStr =
                                    v.rate < 0.01
                                        ? "<0.01/s"
                                        : `${v.rate.toFixed(2)}/s`;

                                // Tooltip Content
                                const tooltipTitle = `Host: ${v.host}\nTotal Flaps: ${v.totalCount}\nDuration: ${durStr}\nAvg Rate: ${rateStr}`;

                                return `<span class="badge voter-badge me-1 mb-1"
                                                      style="cursor:help"
                                                      onclick="jump2alertd('${v.host}', '${row.prefix}')"
                                                      title="${tooltipTitle}">
                                                      ${v.host} <span class="opacity-50 border-start ps-1 ms-1">${rateStr}</span>
                                                </span>`;
                            })
                            .join("");

                        return `
                                        <tr>
                                            <td class="ps-4 font-monospace text-light fw-bold">${row.prefix}</td>
                                            <td class="text-center">
                                                <span class="count-badge ${badgeClass} fw-bold">${row.count}</span>
                                            </td>
                                            <td class="voter-cell text-wrap py-2">
                                                ${votersHtml}
                                            </td>
                                        </tr>
                                    `;
                    })
                    .join("");
            }

            function updateStatusText(count) {
                let text = "Unknown",
                    cls = "text-muted";
                if (count < 10) {
                    text = "Calm";
                    cls = "text-success";
                } else if (count < 50) {
                    text = "Breezy";
                    cls = "text-info";
                } else if (count < 200) {
                    text = "Windy";
                    cls = "text-warning";
                } else {
                    text = "Stormy";
                    cls = "text-danger";
                }

                if (STATE.filters.votes < 3) {
                    text = "Unreliable";
                    cls = "text-muted";
                    UI.statusText.setAttribute(
                        "title",
                        "Consensus threshold < 3. Results may include false positives due to single-server network issues.",
                    );
                    UI.statusText.style.cursor = "help";
                    UI.statusText.style.textDecoration = "underline dotted";
                } else {
                    UI.statusText.removeAttribute("title");
                    UI.statusText.style.cursor = "default";
                    UI.statusText.style.textDecoration = "none";
                }

                UI.statusText.className = `status-hero ${cls}`;
                UI.statusText.innerText = text;
            }

            function renderJsonLinks() {
                const files = [
                    "all.json",
                    "min_2.json",
                    "min_3.json",
                    "min_5.json",
                    "min_7.json",
                    "min_11.json",
                ];
                UI.jsonList.innerHTML = files
                    .map((f) => {
                        const url = window.location.origin + "/" + f;
                        return `
                            <div class="list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between align-items-center py-2">
                                <span class="font-monospace text-muted small">/${f}</span>
                                <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="copyText('${url}')"><i class="bi bi-copy"></i></button>
                            </div>
                        `;
                    })
                    .join("");
            }

            // --- Utils ---
            function copyCode(id) {
                copyText(document.getElementById(id).innerText);
            }

            function copyText(val) {
                navigator.clipboard.writeText(val);
                // Optional: Could add a toast notification here
            }

            function formatDuration(seconds) {
                if (seconds < 60) return `${seconds}s`;
                const m = Math.floor(seconds / 60);
                if (m < 60) return `${m}m`;
                const h = Math.floor(m / 60);
                const remM = m % 60;
                return `${h}h ${remM}m`;
            }

            function gethostname(url) {
                var l = document.createElement("a");
                l.href = url;
                return l.hostname;
            }

            async function jump2alertd(name, prefix = undefined) {
                if (!STATE.data.serverList) {
                    const resp = await fetch(`/servers.json?t=${Date.now()}`);
                    if (!resp.ok) return;
                    const json = await resp.json();
                    STATE.data.serverList = json;
                }
                if (Object.keys(STATE.data.serverList).includes(name)) {
                    const url = STATE.data.serverList[name].url;
                    if (prefix)
                        window.open(
                            `${url}/analyze/?prefix=${prefix}`,
                            "_blank",
                        );
                    else window.open(`${url}`, "_blank");
                }
            }

            // Start
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
